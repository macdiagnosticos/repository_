console.log('Fulcrum Init 1.3 : 2018-06-07 17:40:00');

var verbose = false;
if( window['fulcrum'].p != undefined && window['fulcrum'].p.verbose != undefined){
	if(window['fulcrum'].p.verbose == true){
		verbose = true;
	}
}

if( window['fulcrum'].p != undefined && window['fulcrum'].p.event_listener != undefined){
	var l=window['fulcrum'].p.event_listener;
	if(verbose){ console.log('Fulcrum Listener Added - ('+l+')'); }
	var b=document.querySelector('body');
	b.addEventListener('click', function(e) {

		var ep = e.target
		var found = false;
		while (ep != document && found === false){
			if(ep.hasAttribute(l)){
				fulcrum_event(ep.getAttribute(l));
				found = true;
			}
			ep = ep.parentNode;
		}

	});
}else{
	console.log('Fulcrum Warning: no event listener specified');
}

(function(w,d,f){w[f] = function(v,x,p,z,r){

	var fcsid = cookie_get();
	var xhr;
	if(fcsid==""){
		fcsid = cookie_set();
	}
	p._fcsid = fcsid;
	p._referrer = r;
	p._interaction = v;
	p.verbose = verbose;

	if(verbose){ 
		console.log('Fulcrum: '+v);
		console.log(p);
	}

	var report = {path: w.location.href,campaign_code: x,params: p};

	CORS('POST', '//fk222f8ls1-log.fulcrumsaas.net/log/1.3', report, function( err, resp ) {
	    if(!err){
			console.log(resp);
		}else{
			console.log(err);
		}
	});
		
	if(Object.keys(z).length > 0){
		for(var index in z){
			if(z[index]['type']=='ajax'){
				(function (zi) {
				  var zone = d.getElementById(zi['id']);
				  if(zone !=null){
					CORS('GET', zi['url'], {}, function( err, resp ) {
						if(!err){
							zone.innerHTML = resp;
						}else{
							console.log(err);
						}
					});
				  }
				}(z[index]));
			}
		}
	}

	function cookie_get() {
	    var name = "fulcrum_csid=";
	    var ca = document.cookie.split(';');
	    for(var i = 0; i < ca.length; i++) {
	        var c = ca[i];
	        while (c.charAt(0) == ' ') {
	            c = c.substring(1);
	        }
	        if (c.indexOf(name) == 0) {
	            return c.substring(name.length, c.length);
	        }
	    }
	    return "";
	}

	function cookie_set() {
		var id = 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {var r = Math.random()*16|0,v=c=='x'?r:r&0x3|0x8;return v.toString(16);});
		var d = new Date();
		var dm = document.domain.split('.');
		var dmt = dm.pop();
		dmt = dm.pop() + '.' + dmt;
	    d.setTime(d.getTime() + (99 * 365 * 24 * 60 * 60 * 1000));
	    var expires = "expires="+d.toUTCString();
	    document.cookie = "fulcrum_csid=" + id + ";" + expires + ";path=/;domain="+dmt;
	    return id;
	}

	function CORS(method, url, data, cb) {

	    var xhr = new XMLHttpRequest();

	    if ("withCredentials" in xhr) {
	        xhr.open(method, url, true);
	    } else if (typeof XDomainRequest != "undefined") {
	        xhr = new XDomainRequest();
	        xhr.open(method, url);
	    } else {
	        xhr = null;
	    }

	    xhr.withCredentials = true;
	    xhr.send(JSON.stringify(data));

	    xhr.onload = function() {
	        cb(null, xhr.responseText);
	    };

	    xhr.onerror = function () {
	        cb(true, null);
	    };

	    return xhr;
	}

}})(window, document, 'fulcrum_wedge');

fulcrum_wedge('view','fud6mgf1v0',window['fulcrum'].p,[],document.referrer);

function fulcrum_event(p){

	fulcrum_wedge('event','fud6mgf1v0',JSON.parse(p),{},'');
	console.log('event triggered');
}